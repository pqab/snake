<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Snake</title>
	<style>
		/* 1. main, 11. end */
		.snake-main, .snake-end{
			background:rgba(255, 255, 255, .6);
			left:0;
			position:absolute;
			text-align:center;
			top:0
		}
		/* 3. header */
		.snake-header{
			padding:10px;
		}
		.snake-point{
			color:#0892d0;
			font-size:20px;
			font-weight:bold;
			margin:0;
		}
		/* 4.1 snake, 9.2 apple */
		.snake, .apple{
			background:#000000;
			height:20px;
			position:absolute;
			width:20px;
			z-index:-1
		}
		#snake-head{
			background:#FF0000
		}
		#snake-tail{
			background:#231404;
			visibility:hidden
		}
		/* 9.2 apple */
		.red-apple{
			background:#FF0000
		}
		.gold-apple{
			background:#FFD700
		}
		.purple-apple{
			background:#800080
		}
		.black-apple{
			background:#000000
		}
	</style>
	<script type="text/javascript" src="jquery-1.11.3.min.js"></script>
	<script type="text/javascript">
		var start = false;
		var die = false;
		var point = 0;
		var snake = [];
		var apple = [];
		var appleType = [
			{'type':'red', 'point':100, 'time':10},
			{'type':'gold', 'point':200, 'time':5},
			{'type':'purple', 'point':-100, 'time':10},
			{'type':'black', 'point':-200, 'time':20}
		];
		var type = [];
		//timer
		var timer = null;
		var gameInterval = 90;
		var appleCreateInterval = gameInterval * 30;
		var appleCreateCounter = 0;
		/* listener */
		$(function(){
			initialBoard();
		});
		//2. keydown
		$(document).keydown(function(e){
			var code = e.keyCode || e.which;
			//key code matched arrow keys
			if ($.inArray(code, [37, 38, 39, 40]) != -1){
				//start game if false
				if(!start){
					direction = code;
					startGame();
				}else{
					//change direction if not reverse direction
					//if(code != direction)
					//	moveForward();
					if(!(code + 2 == direction || code - 2 == direction) || snake.length <= 2)
						direction = code;
				}
			}
			//restart game
			if(die){
				$('.snake-main').show();
				$('.snake-end').hide();
				initialBoard();
			}
		});
		/* function */
		//start game
		function startGame(){
			start = true;
			//2. hide main page
			$('.snake-main').hide();
			//8. auto forward
			timer = window.setInterval(function(){
				moveForward();
				//9.2 create apple object
				appleCreateCounter += gameInterval;	
				if (appleCreateCounter == appleCreateInterval) {
					createApple();
					appleCreateCounter = 0;
				}
			}, gameInterval);
			//9.2 create default apple object
			createApple(0);
		}
		//initial game board
		function initialBoard(){
			//restart game
			start = false;
			die = false;
			point = 0;
			snake = [];
			appleCreateCounter = 0;
			$('.snake-point span').html(point);
			$('.snake-body').remove();
			//10.3 calculate point
			type = $.map(appleType, function(value){
				return value['type'];
			});
			//width & height
			var snakeHead = $('#snake-head');
			var windowHeight = $(window).height();
			var windowWidth = $(window).width();
			var snakeHeight = snakeHead.height();
			var snakeWidth = snakeHead.width();
			//3. initial snake board
			var board = $('.snake-board');
			board.css('height', (windowHeight - (windowHeight % snakeHeight) - (snakeHeight * 2)));
			board.css('width', (windowWidth - (windowWidth % snakeWidth) - (snakeWidth * 2)));
			board.css('border', '3px solid #000000');
			board.css('margin', snakeHead.width() - parseFloat(board.css('borderWidth')));
			//4.1 initial snake head
			var offset = snakeHead.offset();
			var boardHeight = board.outerHeight(true);
			var boardWidth = board.outerWidth(true);
			offset.top = (((boardHeight - snakeHeight) / 2) - ((boardHeight - snakeHeight) / 2 % snakeHeight));
			offset.left = (((boardWidth - snakeWidth) / 2) - ((boardWidth - snakeWidth) / 2 % snakeWidth));
			snakeHead.offset(offset);
			snake.push(offset);
			//6. initial snake tail
			var snakeTail = $('#snake-tail');
			offset.top = offset.top + snakeHead.height();
			snakeTail.offset(offset);
			snake.push(offset);
			//1. initial main
			var main = $('.snake-main');
			main.css('height', boardHeight);
			main.css('width', boardWidth);
			//11. initial end
			var end = $('.snake-end');
			end.css('height', boardHeight);
			end.css('width', boardWidth);
			end.hide();
		}
		//move forward
		function moveForward(){
			var snakeHead = $('#snake-head');
			//4.2 move snake to direction
			var offset = snakeHead.offset();
			switch(direction){
				case 37:	//left
					offset.left -= snakeHead.width();
					break;
				case 38:	//up
					offset.top -= snakeHead.height();
					break;
				case 39:	//right
					offset.left += snakeHead.width();
					break;
				case 40:	//down
					offset.top += snakeHead.height();
					break;
			}
			var previous = offset;
			//6. move snake
			var move = $.each(snake, function(index, value){
				$('.snake:nth-child(' + (index + 1) + ')').offset(previous);
				snake[index] = previous;
				previous = value;
			});
			checkCollision();
		}
		//check collision
		function checkCollision(){
			var snakeHead = $('#snake-head');
			var board = $('.snake-board');
			//5. wall
			if(snakeHead.offset().left <= board.offset().left ||	//left
			snakeHead.offset().top <= board.offset().top ||	//top
			(snakeHead.offset().left - snakeHead.width()) >= board.width() ||	//right
			(snakeHead.offset().top - snakeHead.height()) >= board.height())	//bottom
				die = true;
			//7. snake body
			var offset = snakeHead.offset();
			var isSnakeBody = $.grep(snake.slice(1, snake.length-1), function(element, index){
				return element.left == offset.left && element.top == offset.top;
			});
			if(isSnakeBody.length != 0)
				die = true;
			//10.1 apple
			var isApple = $('.apple').filter(function(){
				var appleOffset = $(this).offset();
				return appleOffset.left == offset.left && appleOffset.top == offset.top;
			});
			if(isApple.length != 0){
				var appleEat = isApple[0];
				//10.3 calculate point
				var appleEatType = appleEat.classList.item(1).replace('-apple','');
				var appleEatPoint = appleType[type.indexOf(appleEatType)]['point'];
				point += appleEatPoint;
				$('.snake-point span').html(point);
				//10.4 grow snake
				var snakeBody = $('<div>').addClass('snake').addClass('snake-body');
				var snakeTail = $('#snake-tail');
				snakeTail.before(snakeBody);
				var offset = snakeTail.offset();
				snakeBody.offset(offset);
				offset.top += snakeBody.height();
				snakeTail.offset(offset);
				snake.push(offset);
				//10.2 remove apple
				appleEat.remove();
			}
			if(die)
				gameover();
		}
		//create apple
		function createApple(typeIndex){
			//9.1 random position
			var board = $('.snake-board');
			var snakeHead = $('#snake-head');
			do{
				var left = Math.floor((Math.random() * board.width()) + ((board.outerHeight(true) - board.innerHeight()) / 2));
				var top = Math.floor((Math.random() * board.height()) + ((board.outerWidth(true) - board.innerWidth()) / 2));
				left -= left % snakeHead.width();
				top -= top % snakeHead.height();
				var isSnakeBody = $.grep(snake, function(element, index){
					return element.left == left && element.top == top;
				});
				var isApple = $.grep(apple, function(element, index){
					var offset = $(element).offset();
					return offset.left == left && offset.top == top;
				});
			}while(isSnakeBody.length != 0 || isApple.length != 0);
			//9.2 create apple object
			if(typeIndex == null)
				typeIndex = Math.floor(Math.random() * appleType.length);
			var typeCreate = appleType[typeIndex];
			//append to game board
			var newApple = $('<div>').addClass('apple').addClass(typeCreate['type'] + '-apple');
			$('#apple').append(newApple);
			newApple.offset({top:top, left:left});
			newApple.fadeIn(function(){
				apple.push($(this)[0]);
			}).fadeOut(typeCreate['time'] * 1000, function(){
				apple = $('.apple');
				$(this).remove();
			});
		}
		//gameover
		function gameover(){
			$('.snake-end').show();
			//12.1 Stop game
			window.clearInterval(timer);
			$('.apple').remove();
		}
	</script>
</head>
<body class="snake-board">
	<div class="snake-header">
		<p class="snake-point">Points : <span>0</span></p>
	</div>
	<div id="snake">
		<div id="snake-head" class="snake"></div>
		<div id="snake-tail" class="snake"></div>
	</div>
	<div id="apple"></div>
	<div class="snake-main">
		<table class="snake-main">
			<tr>
				<td><h1>Snake Game</h1></td>
			</tr>
			<tr>
				<td>Press an arrow key to start.</td>
			</tr>
		</table>
	</div>
	<div class="snake-end">
		<table class="snake-end">
			<tr>
				<td class="snake-point">Points : <span>0</span></td>
			</tr>
			<tr>
				<td>Press any key to continue.</td>
			</tr>
		</table>
	</div>
</body>
</html>